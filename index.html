<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>CONTROLLER — Hello Bhuvan</title>
<link rel="manifest" href="manifest.json"/>
<style>
html, body {margin:0; padding:0; width:100%; height:100%; font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial; background:#071024; color:#e6eef8; display:flex; justify-content:center; align-items:flex-start;}
.card{width:100%; max-width:480px; height:100%; border-radius:0; padding:20px; box-sizing:border-box; display:flex; flex-direction:column; background:rgba(255,255,255,0.03); box-shadow:0 10px 35px rgba(2,6,23,0.6);}
h1{text-align:center; font-size:24px; margin:0 0 16px; text-transform:uppercase; color:#10b981;}
label{display:block;font-size:13px;opacity:0.95;margin:10px 0 6px;}
input{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;font-size:16px;}
button{cursor:pointer;padding:12px;border-radius:10px;border:0;background:#10b981;color:#02121a;font-weight:700;transition:0.2s;}
button:hover{opacity:0.85;}
.indicator{display:inline-block;width:20px;height:20px;border-radius:50%;background:#7c7c7c;margin-right:10px;vertical-align:middle;cursor:pointer;}
.indicator.on{background:#10b981;box-shadow:0 0 10px rgba(16,185,129,0.5);}
.phonePreview{margin-top:12px;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);min-height:100px;font-size:16px;box-shadow:0 4px 15px rgba(2,6,23,0.4);}
.small{font-size:14px;}
</style>
</head>
<body>
<div class="card">
<h1>HELLO BHUVAN — CONTROLLER</h1>

<label>Room Code (4 digits)</label>
<input id="room" maxlength="6" placeholder="e.g. 1234"/>

<div class="small">Status: <span id="connStatus"><span class="indicator" id="ind"></span> Not connected</span></div>
<div class="phonePreview" id="ctrlPreview">(No resulter)</div>

<input id="searchText" placeholder="Type search" style="margin-top:12px;display:none"/>
<button id="sendSearch" style="margin-top:8px;display:none">Send Search</button>
</div>

<script>
// Firebase Config
const FIREBASE_CONFIG = {apiKey:"AIzaSyBW65q0kqTtTHgLEXz886wUgIgLtU-B4us",authDomain:"magic-connect-561ba.firebaseapp.com",databaseURL:"https://magic-connect-561ba-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"magic-connect-561ba",storageBucket:"magic-connect-561ba.firebasestorage.app",messagingSenderId:"358307279395",appId:"1:358307279395:web:c9fae2ef0f3f97ba6e7796",measurementId:"G-DF3DHMF1LS"};

function loadFirebaseSDK(cb){if(window.firebase&&window.firebase.database)return cb();const s1=document.createElement('script');s1.src='https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js';s1.onload=()=>{const s2=document.createElement('script');s2.src='https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js';s2.onload=cb;document.head.appendChild(s2)};document.head.appendChild(s1);}

const roomInput=document.getElementById('room'),
searchText=document.getElementById('searchText'),
sendSearch=document.getElementById('sendSearch'),
ind=document.getElementById('ind'),
connStatus=document.getElementById('connStatus'),
ctrlPreview=document.getElementById('ctrlPreview');

let db=null, roomRef=null;

function initFirebase(cb){loadFirebaseSDK(()=>{if(!window.firebase.apps.length){firebase.initializeApp(FIREBASE_CONFIG)}db=firebase.database();cb()})}

// Automatically watch room when code entered
roomInput.addEventListener('change', ()=>{
  let code=(roomInput.value||'').trim();
  if(code.length<4){alert('Enter 4-digit code'); return;}
  initFirebase(()=>{
    roomRef=db.ref('magic/'+code);
    roomRef.on('value', snap=>{
      const v=snap.val();
      if(v && v.joinedBy){
        ind.classList.add('on');
        connStatus.innerHTML='<span class="indicator on"></span> Connected';
        ctrlPreview.textContent='Ready to send';
        searchText.style.display='block';
        sendSearch.style.display='block';
      } else {
        ind.classList.remove('on');
        connStatus.textContent='Not connected';
        ctrlPreview.textContent='(No resulter)';
        searchText.style.display='none';
        sendSearch.style.display='none';
      }
    });
    // Initialize room if not exists
    roomRef.set({joinedBy:false});
  });
});

// Send search (replace previous)
sendSearch.onclick=()=>{
  let code=(roomInput.value||'').trim();
  let text=(searchText.value||'').trim();
  if(!text){alert('Type search'); return;}
  initFirebase(()=>{
    roomRef.update({search:text, ts:Date.now(), joinedBy:true})
    .then(()=>{
      ctrlPreview.textContent='Sent: '+text+' 👍';
      searchText.value='';
    })
    .catch(e=>{alert('Send failed: '+e.message)});
  });
};

// Disconnect by clicking indicator
ind.onclick=()=>{
  let code=(roomInput.value||'').trim();
  if(!code)return;
  if(!confirm('Disconnect room?'))return;
  initFirebase(()=>{
    db.ref('magic/'+code).remove().then(()=>{
      ind.classList.remove('on');
      connStatus.textContent='Not connected';
      ctrlPreview.textContent='(Disconnected)';
      searchText.style.display='none';
      sendSearch.style.display='none';
    });
  });
};

// PWA Service Worker
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(()=>console.log('SW registered'));
}
</script>
</body>
</html>
